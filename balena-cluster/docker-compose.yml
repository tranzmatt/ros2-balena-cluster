version: "2.1"

services:
  ros-node:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    privileged: true
    network_mode: host
    restart: always
    environment:
      # ROS2 Discovery
      - ROS_DISCOVERY_SERVER=${ROS_DISCOVERY_SERVER}
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}
      - RMW_IMPLEMENTATION=${RMW_IMPLEMENTATION:-rmw_fastrtps_cpp}
      - ROS_LOCALHOST_ONLY=${ROS_LOCALHOST_ONLY:-0}
      - ROS_SUPER_CLIENT=${ROS_SUPER_CLIENT:-false}
      # Node behavior
      - NODE_ROLE=${NODE_ROLE:-idle}
      # Camera settings
      - CAMERA_WIDTH=${CAMERA_WIDTH:-640}
      - CAMERA_HEIGHT=${CAMERA_HEIGHT:-480}
      - CAMERA_FPS=${CAMERA_FPS:-1.0}
      - CAMERA_JPEG_QUALITY=${CAMERA_JPEG_QUALITY:-80}
      # Image viewer settings
      - SAVE_IMAGES=${SAVE_IMAGES:-false}
      - SAVE_PATH=${SAVE_PATH:-/shared/images}
      - SAVE_INTERVAL=${SAVE_INTERVAL:-10}
    volumes:
      - ros2-logs:/root/.ros/log
      - shared-data:/shared
    labels:
      io.balena.features.dbus: "1"
      io.balena.features.kernel-modules: "1"

volumes:
  ros2-logs:
  shared-data:
